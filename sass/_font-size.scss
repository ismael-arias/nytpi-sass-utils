$base-font-size-unitless: 16 !global;

// Easy-peasy mixin to calculate an em value from the ratio of a given integer and the current font-size integer value
@function em($unitless, $font-size: $base-font-size-unitless) {
    @return 1em * $unitless / $font-size;
}

// Clever font-size mixin that changes value of $base-font-size-unitless in-scope
// Also supports vw-unit output based on the current Susy layout
@mixin font-size($new-font-size: 16, $output-unit: px, $scale-mode: none) {
    $old: $base-font-size-unitless;
    // Reassign $base-font-size-unitless in this scope, and restore it once we're done
    $base-font-size-unitless: $new-font-size !global;

    $vw-value: $new-font-size / map-get($susy, columns) * 100vw;

    $is-desktop-layout: ($susy and map-has-key($susy, name) and map-get($susy, name) == desktop);

    // Automatically enable upscaling for px values in the `desktop` layout
    @if $output-unit == px and $is-desktop-layout {
        $scale-mode: upscale;
    }

    @if $output-unit == px {
        font-size: px($new-font-size);

        // Scale the font size in the `beyond-desktop` size-class breakpoint
        @if $scale-mode == upscale and $is-desktop-layout {
            @include susy-breakpoint(beyond-desktop) {
                font-size: $vw-value;
            }
        }
    } @else if $output-unit == vw {
        font-size: $vw-value;
    }
    
    // Temporary hack to limit font-size to a scaled pixel value for susy-size-class's `shell` breakpoint
    @if ($output-unit == vw or $scale-mode == upscale) and map-has-key($susy, name) and $widths and map-has-key($widths, map-get($susy, name)) {
        @include susy-breakpoint(shell) {
            $scaled-font-size: $new-font-size * $shell-width / map-get($widths, map-get($susy, name) );
            font-size: px($scaled-font-size);
        }
    }
  
    // Any calls to em() here will be aware of our current $base-font-size-unitless value
    @content;

    // Restore the old value of $base $base-font-size-unitless
    $base-font-size-unitless: $old !global;
}
